# دليل الترحيل إلى Backblaze B2 مع ضغط الوسائط

## نظرة عامة

تم تحديث خادم **مهنتي لي** للانتقال من **Cloudinary** إلى **Backblaze B2** كخدمة تخزين للوسائط، مع إضافة ميزة **ضغط الصور والفيديوهات** قبل الرفع لتوفير مساحة التخزين وتقليل التكاليف.

## التغييرات الرئيسية

### 1. خدمة التخزين الجديدة (Backblaze B2)

| الميزة | Cloudinary (القديم) | Backblaze B2 (الجديد) |
|--------|---------------------|----------------------|
| التكلفة | مرتفعة | منخفضة جداً ($6/TB) |
| الخطة المجانية | محدودة | 10GB مجاناً دائماً |
| التحميل المجاني | محدود | 3x التخزين الشهري |
| التوافق مع S3 | لا | نعم |

### 2. ضغط الوسائط

#### ضغط الصور
- **التنسيق**: WebP (أصغر حجماً بنسبة 30-50%)
- **الجودة**: 70% (توازن بين الجودة والحجم)
- **الأبعاد القصوى**: 1080x1920 بكسل
- **صور الملف الشخصي**: 400x400 بكسل

#### ضغط الفيديوهات
- **التنسيق**: MP4 (H.264)
- **CRF**: 28 (ضغط جيد مع جودة مقبولة)
- **الأبعاد القصوى**: 720x1280 بكسل
- **معدل بت الصوت**: 96kbps

## إعداد Backblaze B2

### الخطوة 1: إنشاء حساب

1. اذهب إلى [backblaze.com](https://www.backblaze.com)
2. أنشئ حساب جديد (مجاني)
3. فعّل B2 Cloud Storage

### الخطوة 2: إنشاء Bucket

1. من لوحة التحكم، اذهب إلى **B2 Cloud Storage** > **Buckets**
2. انقر على **Create a Bucket**
3. اختر اسماً فريداً (مثل: `mehnati-media`)
4. اختر **Public** للسماح بالوصول العام للملفات

### الخطوة 3: إنشاء Application Key

1. اذهب إلى **App Keys**
2. انقر على **Generate New Master Application Key**
3. احفظ المفاتيح:
   - **keyID**: مثل `c85e8d15e076`
   - **applicationKey**: المفتاح السري (يظهر مرة واحدة فقط)

### الخطوة 4: تحديث متغيرات البيئة

أضف المتغيرات التالية إلى ملف `.env`:

```env
B2_APPLICATION_KEY_ID=c85e8d15e076
B2_APPLICATION_KEY=003ca2503106157a278e32be7843c5c0eb1a69fc83
B2_BUCKET_NAME=mehnati-media
```

## تثبيت الحزم المطلوبة

```bash
npm install backblaze-b2
```

**ملاحظة**: حزمة `sharp` موجودة مسبقاً لضغط الصور، و FFmpeg مطلوب لضغط الفيديوهات.

### تثبيت FFmpeg (للخادم)

```bash
# Ubuntu/Debian
sudo apt update && sudo apt install ffmpeg -y

# macOS
brew install ffmpeg

# Windows
# قم بتحميل FFmpeg من https://ffmpeg.org/download.html
```

## الملفات الجديدة

| الملف | الوصف |
|-------|-------|
| `src/config/backblaze.js` | إعدادات الاتصال بـ Backblaze B2 |
| `src/services/compressionService.js` | خدمة ضغط الصور والفيديوهات |
| `src/services/storageService.js` | خدمة التخزين الموحدة |

## الملفات المحدثة

| الملف | التغييرات |
|-------|----------|
| `src/middleware/upload.js` | استخدام Memory Storage بدلاً من Cloudinary |
| `src/controllers/uploadController.js` | استخدام خدمة التخزين الجديدة |
| `src/controllers/storyController.js` | دعم Backblaze B2 |
| `src/controllers/userController.js` | رفع الصور الشخصية مع الضغط |
| `src/server.js` | تهيئة Backblaze B2 وتحديث CSP |
| `package.json` | إضافة حزمة backblaze-b2 |

## نسب الضغط المتوقعة

| نوع الملف | الحجم الأصلي | الحجم بعد الضغط | التوفير |
|-----------|-------------|-----------------|---------|
| صورة JPEG | 2 MB | 400 KB | ~80% |
| صورة PNG | 5 MB | 800 KB | ~84% |
| فيديو MP4 | 50 MB | 15 MB | ~70% |
| فيديو MOV | 100 MB | 25 MB | ~75% |

## الخطة المجانية لـ Backblaze B2

| الميزة | الحد المجاني |
|--------|-------------|
| التخزين | 10 GB |
| الرفع | غير محدود |
| التحميل | 3x التخزين الشهري |
| API Calls (Class A) | مجاني |
| API Calls (Class B/C) | 2,500/يوم مجاناً |

## التوافق مع الملفات القديمة

الملفات المرفوعة سابقاً على Cloudinary ستستمر في العمل. تم الإبقاء على دعم روابط Cloudinary في إعدادات CSP للتوافق.

## ملاحظات مهمة

1. **FFmpeg مطلوب** لضغط الفيديوهات على الخادم
2. **الملفات الكبيرة** قد تستغرق وقتاً أطول للضغط
3. **الخطة المجانية** كافية للبداية (10GB تخزين)
4. **التكلفة بعد الخطة المجانية**: $6 لكل تيرابايت شهرياً

## الدعم

للمساعدة أو الاستفسارات، تواصل مع فريق التطوير.

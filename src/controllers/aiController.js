const axios = require('axios');
const Post = require('../models/Post');
const ExternalJob = require('../models/ExternalJob');

// ============================================
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OpenAI API
// ============================================
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const OPENAI_BASE_URL = process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1';
const OPENAI_MODEL = process.env.OPENAI_MODEL || 'gpt-4.1-mini';

console.log('ğŸ”§ [INIT] AI Configuration:');
console.log(`   Model: ${OPENAI_MODEL}`);
console.log(`   API Key: ${OPENAI_API_KEY ? 'âœ… Configured' : 'âŒ Missing'}`);

// ============================================
// Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
// ============================================
const APP_KNOWLEDGE = `
# Ø¯Ù„ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„

## Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
ØªØ·Ø¨ÙŠÙ‚ "Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ" Ù‡Ùˆ Ù…Ù†ØµØ© ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ù…Ù‡Ù†ÙŠØ© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠØŒ ØªØ¬Ù…Ø¹ Ø¨ÙŠÙ†:
- Ø´Ø¨ÙƒØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ (Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆÙ‚ØµØµ)
- Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ (Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„/Ù…ÙˆØ¸ÙÙŠÙ†)
- Ø§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© (Ø§Ù„Ø­Ø±Ø§Ø¬)
- Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ

---

## Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„

### Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯:
1. Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø®ØªØ± "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯"
2. Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨:
   - ÙØ±Ø¯ÙŠ: Ù„Ù„Ø¨Ø§Ø­Ø«ÙŠÙ† Ø¹Ù† Ø¹Ù…Ù„
   - ØªØ¬Ø§Ø±ÙŠ: Ù„Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ£ØµØ­Ø§Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
3. Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¯ÙˆÙ„Ø©
4. Ø³ØªØªÙ„Ù‚Ù‰ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ (OTP) Ø¹Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ - Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…
5. ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©

### ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:
- Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
- Ø§Ø¶ØºØ· "Ø¯Ø®ÙˆÙ„"

### Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:
- Ø§Ø¶ØºØ· "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
- Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
- Ø³ØªØªÙ„Ù‚Ù‰ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†

### ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:
1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„ØªØ±Ø³) ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
2. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù…Ùƒ/Ø­Ø³Ø§Ø¨Ùƒ
3. Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
4. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« (â‹®) ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙŠØ§
5. Ø§Ø®ØªØ± "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"
6. Ø£ÙƒØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬

---

## ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„ØªÙ†Ù‚Ù„

### Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ:
- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Home): Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù‚ØµØµ
- ÙˆØ¸Ø§Ø¦Ù (Jobs): Ù‚Ø³Ù… Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„Ù…Ù‡Ù†ÙŠ
- Ù…Ø³ØªØ¹Ø¬Ù„ (Urgent): Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± - Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙÙˆØ±ÙŠØ© ÙˆØ§Ù„ÙŠÙˆÙ…ÙŠØ©
- Ø¹Ø§Ù„Ù…ÙŠ (Global): ÙˆØ¸Ø§Ø¦Ù Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø®Ø§Ø±Ø¬ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù…
- Ø­Ø±Ø§Ø¬ (Haraj): Ø³ÙˆÙ‚ Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡

### Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ:
- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
- Ø§Ù„Ø¨Ø­Ø«
- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© (CV Wizard)
- Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø´Ø±Ø§Ø±Ø©)
- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª

---

## Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ± Ø£Ùˆ ÙˆØ¸ÙŠÙØ©

### Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:
1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± (+) Ø£Ùˆ Ø¹Ù„Ù‰ "Ø¨Ù… ØªÙÙƒØ±..." ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
2. Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ
3. Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ:
   - ÙˆØ¸Ø§Ø¦Ù: Ø³Ø§Ø¦Ù‚ØŒ Ù…Ø­Ø§Ø³Ø¨ØŒ Ù…Ù‡Ù†Ø¯Ø³ØŒ Ù…Ø¨Ø±Ù…Ø¬...
   - Ø­Ø±Ø§Ø¬: Ø³ÙŠØ§Ø±Ø§ØªØŒ Ø¹Ù‚Ø§Ø±Ø§ØªØŒ Ø£Ø¬Ù‡Ø²Ø©...
   - Ø¹Ø§Ù…: Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©
4. Ø­Ø¯Ø¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù†Ø´Ø±:
   - Ù…Ø­Ù„ÙŠ: Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø© ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø©
   - Ø¹Ø§Ù„Ù…ÙŠ: ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹
5. Ù„Ù„ÙˆØ¸Ø§Ø¦ÙØŒ Ø§Ø®ØªØ±:
   - "Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸ÙÙŠÙ†" (Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„)
   - "Ø£Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„" (Ù„Ù„Ø¨Ø§Ø­Ø« Ø¹Ù† ÙˆØ¸ÙŠÙØ©)
6. Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„: Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ ÙˆØ§ØªØ³Ø§Ø¨
7. Ø§Ø®ØªØ± Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
8. Ø§Ø¶ØºØ· "Ù†Ø´Ø±"

### ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±:
- Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« (â‹®) Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù†Ø´ÙˆØ±Ùƒ
- Ø§Ø®ØªØ±: Ø­Ø°ÙØŒ Ø¥Ø®ÙØ§Ø¡ØŒ Ø£Ùˆ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ¸ÙŠÙØ©

---

## Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø¬Ù„ (Urgent Jobs)

Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ØµØµ Ù„Ù„ÙØ±Øµ Ø§Ù„ÙÙˆØ±ÙŠØ© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø© Ù„Ù„ÙˆÙ‚Øª.

### Ù‚Ø§Ø¹Ø¯Ø© Ù…Ù‡Ù…Ø©:
Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø· Ù„Ø£ØµØ­Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„ (Employers).
Ø¥Ø°Ø§ Ø­Ø§ÙˆÙ„ Ø¨Ø§Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„ Ø§Ù„Ù†Ø´Ø± Ù‡Ù†Ø§ØŒ Ø³ÙŠØªØ­ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ "Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸ÙÙŠÙ†".

### Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª:
1. Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„Ø¢Ù† (Needed Now): Ù„Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„ÙÙˆØ±ÙŠ
2. Ø¹Ù‚ÙˆØ¯ Ù…Ø¤Ù‚ØªØ© (Temp Contracts): Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù„
3. Ø¯ÙØ¹ ÙŠÙˆÙ…ÙŠ (Daily Payment): Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø­Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©

---

## Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© (CV Builder)

### ÙƒÙŠÙÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©:
1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ (+) ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
2. Ø§Ø®ØªØ± "Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©"
3. Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
   - Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©)
   - Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
   - Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
   - ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
   - Ø§Ù„Ø®Ø¨Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
   - Ø§Ù„ØªØ¹Ù„ÙŠÙ…
   - Ø§Ù„Ù„ØºØ§Øª
   - Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø©

### Ø§Ù„Ù†ØªÙŠØ¬Ø©:
- Ø¨Ø·Ø§Ù‚Ø© Ø±Ù‚Ù…ÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Ù„Ø¨
- Ø±Ù…Ø² QR Ø´Ø®ØµÙŠ
- Ù…Ø¹Ø±Ù Ù…Ù‡Ù†ÙŠ ÙØ±ÙŠØ¯
- ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§ Ø£Ùˆ ØªØµØ¯ÙŠØ±Ù‡Ø§

---

## ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Premium Features)

### Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØªÙ…ÙŠÙŠØ²ØŸ
Ø§Ù„ØªÙ…ÙŠÙŠØ² ÙŠØ¬Ø¹Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆÙŠØµÙ„ Ù„Ø¬Ù…Ù‡ÙˆØ± Ø£ÙˆØ³Ø¹.

### Ø§Ù„Ù…Ø²Ø§ÙŠØ§:
- Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
- Ø´Ø§Ø±Ø© "Ù…Ù…ÙŠØ²" (Ù†Ø¬Ù…Ø©) Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
- Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…Ù‡ÙˆØ± Ø®Ø§Ø±Ø¬ Ù…Ø¯ÙŠÙ†ØªÙƒ
- Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª 3-5 Ù…Ø±Ø§Øª

### Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:
- 24 Ø³Ø§Ø¹Ø©: Ù…Ø¬Ø§Ù†ÙŠ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯)
- Ø£Ø³Ø¨ÙˆØ¹: ØªØ«Ø¨ÙŠØª Ù„Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹
- Ø´Ù‡Ø±: ØªØ«Ø¨ÙŠØª Ù„Ù…Ø¯Ø© Ø´Ù‡Ø± ÙƒØ§Ù…Ù„

### ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙ…ÙŠÙŠØ²:
1. Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŒ Ø§Ø®ØªØ± "ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
2. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø© (24 Ø³Ø§Ø¹Ø©ØŒ Ø£Ø³Ø¨ÙˆØ¹ØŒ Ø´Ù‡Ø±)
3. Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†Ø´Ø±

---

## Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Global Jobs)

### Ù…Ø§ Ù‡Ùˆ Ù‚Ø³Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØŸ
ÙŠØ¹Ø±Ø¶ ÙˆØ¸Ø§Ø¦Ù Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø®Ø§Ø±Ø¬ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù….

### Ù„Ù…Ø§Ø°Ø§ ØªØ¸Ù‡Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŸ
Ù„Ø£Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©. Ù‡Ø°Ù‡ ÙˆØ¸Ø§Ø¦Ù Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø´Ø±ÙƒØ§Øª Ø¹Ø§Ù„Ù…ÙŠØ©.

### ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ±Ø¬Ù…Ø©:
1. Ø§ÙØªØ­ Ø£ÙŠ ÙˆØ¸ÙŠÙØ© ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
2. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªØ±Ø¬Ù…Ø©"
3. Ø³ÙŠØªÙ… ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©

### ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ© Ø¹Ø§Ù„Ù…ÙŠØ©:
1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„
2. Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª ÙˆØ§Ù„ÙˆØµÙ
3. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙ‚Ø¯ÙŠÙ…" Ø£Ùˆ "Apply"
4. Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ùƒ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù„Ù„Ø´Ø±ÙƒØ©
5. Ø£ÙƒÙ…Ù„ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø´Ø±ÙƒØ©

---

## Ø§Ù„Ù‚ØµØµ (Stories)

### ÙƒÙŠÙÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù‚ØµØ©:
1. ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ (+) Ø¨Ø¬Ø§Ù†Ø¨ ØµÙˆØ±ØªÙƒ
2. Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ
3. Ø£Ø¶Ù Ù†ØµÙˆØµ Ø£Ùˆ Ù…Ù„ØµÙ‚Ø§Øª Ø£Ùˆ ÙÙ„Ø§ØªØ±
4. Ø§Ø¶ØºØ· "Ù…Ø´Ø§Ø±ÙƒØ©"

### Ù…Ù„Ø§Ø­Ø¸Ø©:
Ø§Ù„Ù‚ØµØµ ØªØ®ØªÙÙŠ Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©.

---

## Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨

### Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:
Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ±Ø³ (âš™ï¸) ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©

### Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:
- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ: Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø§Ù„ØºÙ„Ø§ÙØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù†Ø¨Ø°Ø©
- Ø§Ù„Ù„ØºØ©: Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Dark Mode)
- Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´Ø§ÙƒÙ„
- Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ (ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©)

---

## Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø£Ù…Ø§Ù†

- Ù„Ø§ ØªØ¯ÙØ¹ Ø£ÙŠ Ù…Ø¨Ø§Ù„Øº Ù„Ø£ÙŠ Ø´Ø®Øµ
- ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„
- Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø³Ù…ÙŠØ©
- Ø£Ø¨Ù„Øº Ø¹Ù† Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ Ù…Ø´Ø¨ÙˆÙ‡
`;

// ============================================
// System Prompt Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// ============================================
const SYSTEM_PROMPT = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„ØªØ·Ø¨ÙŠÙ‚ "Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ" - Ù…Ù†ØµØ© ØªÙˆØ¸ÙŠÙ ÙˆØªÙˆØ§ØµÙ„ Ù…Ù‡Ù†ÙŠ Ø¹Ø±Ø¨ÙŠØ©.

## Ù…Ù‡Ù…ØªÙƒ:
- Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ ÙÙ‡Ù… ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙ‡Ù… Ø­ÙˆÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Øª ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù
- ØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ù…Ù‡Ù†ÙŠØ© Ø¹Ø§Ù…Ø©
- Ø§Ù„Ø±Ø¯ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ù‡Ø°Ø¨ ÙˆÙˆØ¯ÙˆØ¯

## Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø© ÙŠØ¬Ø¨ Ø§ØªØ¨Ø§Ø¹Ù‡Ø§:

### 1. Ø§Ù„Ù„ØºØ©:
- Ø±Ø¯ Ø¨Ù†ÙØ³ Ù„ØºØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹
- Ø¥Ø°Ø§ ÙƒØªØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ø±Ø¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
- Ø¥Ø°Ø§ ÙƒØªØ¨ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø±Ø¯ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
- Ø¥Ø°Ø§ ÙƒØªØ¨ Ø¨Ø£ÙŠ Ù„ØºØ© Ø£Ø®Ø±Ù‰ØŒ Ø±Ø¯ Ø¨Ù†ÙØ³ Ø§Ù„Ù„ØºØ©

### 2. Ù…Ø§ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡ (Ø§Ø¹ØªØ°Ø± Ø¨Ø£Ø¯Ø¨):
- Ù„Ø§ ØªØ¨Ø­Ø« Ø¹Ù† ÙˆØ¸Ø§Ø¦Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù‚Ù„: "Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¸Ø§Ø¦ÙØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø³Ù… Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚")
- Ù„Ø§ ØªÙ†Ø´Ø¦ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø£Ùˆ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Ù‚Ù„: "Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±Ø§ØªØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø´Ø±Ø­ ÙƒÙŠÙÙŠØ© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§")
- Ù„Ø§ ØªÙƒØªØ¨ Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø±Ù…Ø¬ÙŠØ©
- Ù„Ø§ ØªÙ†Ø´Ø¦ Ø³ÙŠØ± Ø°Ø§ØªÙŠØ© ÙƒØ§Ù…Ù„Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø·Ø§Ø¡ Ù†ØµØ§Ø¦Ø­ ÙÙ‚Ø·)
- Ù„Ø§ ØªØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø£Ø´Ø®Ø§Øµ Ø¢Ø®Ø±ÙŠÙ† Ù†ÙŠØ§Ø¨Ø© Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

### 3. Ù…Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡:
- Ø´Ø±Ø­ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ Ù…ÙŠØ²Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
- ØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©
- Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ù…Ù‚Ø§Ø¨Ù„Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©
- Ø´Ø±Ø­ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù† Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

### 4. Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø±Ø¯:
- ÙƒÙ† Ù…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹
- Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø­
- ÙƒÙ† ÙˆØ¯ÙˆØ¯Ø§Ù‹ ÙˆÙ…Ù‡Ø°Ø¨Ø§Ù‹
- Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙƒØ«ÙŠØ±Ø© (ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø§Ø«Ù†ÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)

### 5. Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±:
Ù‚Ù„: "ØªÙ… ØªØ·ÙˆÙŠØ±ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ù…Ù„ - ÙØ±ÙŠÙ‚ ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ"

${APP_KNOWLEDGE}
`;

// ============================================
// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
// ============================================

// ÙƒØ´Ù Ù„ØºØ© Ø§Ù„Ù†Øµ
function detectLanguage(text) {
  if (!text) return 'ar';
  
  // ÙƒØ´Ù Ø§Ù„ØµÙŠÙ†ÙŠØ©
  if (/[\u4E00-\u9FFF]/.test(text)) return 'zh';
  
  // ÙƒØ´Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
  if (/[\u0600-\u06FF]/.test(text)) return 'ar';
  
  // ÙƒØ´Ù Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  if (/^[a-zA-Z\s\d.,!?'"()-]+$/.test(text)) return 'en';
  
  return 'ar'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ù„Ø¨Ø§Øª Ù…Ù…Ù†ÙˆØ¹Ø©
function isForbiddenRequest(message) {
  const lowerMessage = message.toLowerCase();
  
  // Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¸Ø§Ø¦Ù
  const jobSearchPatterns = [
    /Ø§Ø¨Ø­Ø«\s*(Ù„ÙŠ)?\s*(Ø¹Ù†)?\s*ÙˆØ¸ÙŠÙ/i,
    /Ø¯ÙˆØ±\s*(Ù„ÙŠ)?\s*(Ø¹Ù†)?\s*ÙˆØ¸ÙŠÙ/i,
    /Ø¬ÙŠØ¨\s*(Ù„ÙŠ)?\s*ÙˆØ¸ÙŠÙ/i,
    /find\s*(me)?\s*a?\s*job/i,
    /search\s*(for)?\s*job/i
  ];
  
  for (const pattern of jobSearchPatterns) {
    if (pattern.test(message)) {
      return {
        blocked: true,
        reason: 'job_search',
        response: 'Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¸Ø§Ø¦Ù Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†ÙƒØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ! Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… "ÙˆØ¸Ø§Ø¦Ù" ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£Ù† Ø£Ø´Ø±Ø­ Ù„Ùƒ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø³Ù… Ø§Ù„ÙˆØ¸Ø§Ø¦ÙØŸ'
      };
    }
  }
  
  // Ø·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±
  const createPostPatterns = [
    /Ø§Ù†Ø´Ø¦\s*(Ù„ÙŠ)?\s*Ù…Ù†Ø´ÙˆØ±/i,
    /Ø§ÙƒØªØ¨\s*(Ù„ÙŠ)?\s*Ù…Ù†Ø´ÙˆØ±/i,
    /Ø§Ù†Ø´Ø±\s*(Ù„ÙŠ)?\s*Ø§Ø¹Ù„Ø§Ù†/i,
    /create\s*(a)?\s*post/i,
    /write\s*(a)?\s*post/i
  ];
  
  for (const pattern of createPostPatterns) {
    if (pattern.test(message)) {
      return {
        blocked: true,
        reason: 'create_post',
        response: 'Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†ÙƒØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø´Ø±Ø­ Ø§Ù„Ø®Ø·ÙˆØ§Øª! Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± (+) Ø£Ùˆ Ø¹Ù„Ù‰ "Ø¨Ù… ØªÙÙƒØ±..." Ø«Ù… Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆØ§Ùƒ ÙˆØ§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø­Ø§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ØŸ'
      };
    }
  }
  
  // Ø·Ù„Ø¨ ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯
  const codePatterns = [
    /Ø§ÙƒØªØ¨\s*(Ù„ÙŠ)?\s*ÙƒÙˆØ¯/i,
    /Ø§Ù†Ø´Ø¦\s*(Ù„ÙŠ)?\s*ÙƒÙˆØ¯/i,
    /Ø¨Ø±Ù…Ø¬\s*(Ù„ÙŠ)?/i,
    /write\s*(me)?\s*(a)?\s*code/i,
    /create\s*(a)?\s*script/i,
    /program\s*(for)?\s*(me)?/i
  ];
  
  for (const pattern of codePatterns) {
    if (pattern.test(message)) {
      return {
        blocked: true,
        reason: 'code_request',
        response: 'Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø®ØµØµ Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ ÙÙ‚Ø·ØŒ ÙˆÙ„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ ÙƒØªØ§Ø¨Ø© Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø±Ù…Ø¬ÙŠØ©. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø± Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ'
      };
    }
  }
  
  return { blocked: false };
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±
function isCreatorQuestion(message) {
  const patterns = [
    /Ù…Ù†\s*(Ø·ÙˆØ±Ùƒ|ØµÙ†Ø¹Ùƒ|Ø§Ù†Ø´Ø£Ùƒ|Ø¨Ø±Ù…Ø¬Ùƒ)/i,
    /who\s*(made|created|developed)\s*you/i,
    /Ù…Ù†\s*Ø§Ù†Øª/i,
    /who\s*are\s*you/i
  ];
  
  for (const pattern of patterns) {
    if (pattern.test(message)) return true;
  }
  return false;
}

// ============================================
// Handler Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
// ============================================
exports.chatWithAI = async (req, res) => {
  try {
    let { message, conversationHistory } = req.body;
    console.log('ğŸ“¨ AI chat:', message);

    if (!message || !String(message).trim()) {
      return res.status(400).json({ success: false, message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø³Ø§Ù„Ø©' });
    }

    if (!conversationHistory) conversationHistory = [];
    if (!Array.isArray(conversationHistory)) conversationHistory = [];
    conversationHistory = conversationHistory.filter(m => m && m.role && m.content && String(m.content).trim());

    const userMessage = String(message).trim();
    const detectedLang = detectLanguage(userMessage);

    // SSE headers
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    res.setHeader('X-Accel-Buffering', 'no');

    // 1) Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø©
    const forbidden = isForbiddenRequest(userMessage);
    if (forbidden.blocked) {
      console.log(`âŒ Blocked request: ${forbidden.reason}`);
      res.write('data: ' + JSON.stringify({ type: 'chunk', content: forbidden.response }) + '\n\n');
      res.write('data: ' + JSON.stringify({ type: 'done', fullResponse: forbidden.response, source: 'policy_block' }) + '\n\n');
      res.end();
      return;
    }

    // 2) Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±
    if (isCreatorQuestion(userMessage)) {
      const creatorResponse = detectedLang === 'en' 
        ? 'I was developed by Team Al-Amal - the Mehnati Li app development team.'
        : 'ØªÙ… ØªØ·ÙˆÙŠØ±ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ù…Ù„ - ÙØ±ÙŠÙ‚ ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ.';
      res.write('data: ' + JSON.stringify({ type: 'chunk', content: creatorResponse }) + '\n\n');
      res.write('data: ' + JSON.stringify({ type: 'done', fullResponse: creatorResponse, source: 'creator' }) + '\n\n');
      res.end();
      return;
    }

    // 3) Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI API Ù„Ù„Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ
    if (!OPENAI_API_KEY) {
      const fallback = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
      res.write('data: ' + JSON.stringify({ type: 'chunk', content: fallback }) + '\n\n');
      res.write('data: ' + JSON.stringify({ type: 'done', fullResponse: fallback, source: 'error' }) + '\n\n');
      res.end();
      return;
    }

    // Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„ØºØ© Ù„Ù„Ù€ System Prompt
    let langInstruction = '';
    if (detectedLang === 'en') {
      langInstruction = '\n\nIMPORTANT: The user is writing in English. Respond in English only.';
    } else if (detectedLang === 'zh') {
      langInstruction = '\n\nIMPORTANT: The user is writing in Chinese. Respond in Chinese only.';
    } else {
      langInstruction = '\n\nIMPORTANT: The user is writing in Arabic. Respond in Arabic only.';
    }

    const messages = [
      { role: 'system', content: SYSTEM_PROMPT + langInstruction },
      ...conversationHistory.slice(-10), // Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø·
      { role: 'user', content: userMessage }
    ];

    try {
      const response = await axios.post(
        `${OPENAI_BASE_URL}/chat/completions`,
        {
          model: OPENAI_MODEL,
          messages: messages,
          max_tokens: 1000,
          temperature: 0.7,
          stream: false
        },
        {
          headers: {
            'Authorization': `Bearer ${OPENAI_API_KEY}`,
            'Content-Type': 'application/json'
          },
          timeout: 30000
        }
      );

      const aiResponse = response.data.choices[0].message.content;
      console.log('âœ… AI Response generated');

      res.write('data: ' + JSON.stringify({ type: 'chunk', content: aiResponse }) + '\n\n');
      res.write('data: ' + JSON.stringify({ type: 'done', fullResponse: aiResponse, source: 'openai' }) + '\n\n');
      res.end();

    } catch (apiError) {
      console.error('âŒ OpenAI API Error:', apiError.message);
      
      // Fallback response
      const fallback = detectedLang === 'en'
        ? 'Sorry, I encountered an error. Please try again or rephrase your question.'
        : 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ© Ø³Ø¤Ø§Ù„Ùƒ.';
      
      res.write('data: ' + JSON.stringify({ type: 'chunk', content: fallback }) + '\n\n');
      res.write('data: ' + JSON.stringify({ type: 'done', fullResponse: fallback, source: 'fallback' }) + '\n\n');
      res.end();
    }

  } catch (error) {
    console.error('Chat handler error:', error.message);
    if (!res.headersSent) res.setHeader('Content-Type', 'text/event-stream');
    const errMsg = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';
    res.write('data: ' + JSON.stringify({ type: 'error', message: errMsg, error: error.message }) + '\n\n');
    res.end();
  }
};

// ============================================
// Health check
// ============================================
exports.checkOllamaHealth = async (req, res) => {
  try {
    const hasApiKey = !!OPENAI_API_KEY;
    
    res.json({
      success: true,
      message: hasApiKey ? 'AI Service Ready' : 'API Key Missing',
      model: OPENAI_MODEL,
      status: hasApiKey ? 'âœ… Ø¬Ø§Ù‡Ø²' : 'âŒ ØºÙŠØ± Ù…ØªØ§Ø­'
    });
  } catch (error) {
    console.error('Health check failed:', error.message);
    res.status(503).json({ success: false, message: 'ØºÙŠØ± Ù…ØªØ§Ø­', error: error.message });
  }
};

const axios = require('axios');

// ============================================
// ðŸ¤– Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Ollama
// ============================================
const OLLAMA_BASE_URL = process.env.LLM_BASE_URL || 'http://127.0.0.1:11434';
const OLLAMA_MODEL = process.env.LLM_MODEL || 'qwen2.5:7b-instruct';
const ASSISTANT_NAME = process.env.ASSISTANT_NAME || 'Ù…Ø³ØªØ´Ø§Ø± Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ';

console.log('ðŸ”§ [INIT] AI Smart Logic Loaded');

// ============================================
// ðŸ“š Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© (Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§Ù…)
// Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ù…Ù†Ø§ Ø¨ÙØµÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„ÙƒÙŠ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ†Ù‡Ø§
// ============================================
const KNOWLEDGE_BASE = [
  {
    topic: 'Ø³Ø¨Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
    keywords: ['Ù„Ù…Ø§Ø°Ø§ Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ù„ÙŠØ´ Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ù„ØºØ© Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', 'Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'ØªØ±Ø¬Ù…Ø©'],
    info: 'ØªØ¸Ù‡Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ø£Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù‡Ø§ Ø£Ø¬Ù†Ø¨ÙŠ. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠÙˆÙØ± Ù…ÙŠØ²Ø© ØªØ±Ø¬Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©ØŒ Ù„ÙƒÙ† Ø§Ù„Ø£ØµÙ„ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù„Ø¯Ù‚Ø©.'
  },
  {
    topic: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©',
    keywords: ['ÙƒÙŠÙ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©', 'Ø´Ø±Ø­ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©', 'ÙƒÙŠÙ Ø§Ø¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠ', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ¸Ø§Ø¦Ù'],
    info: 'Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙØ­Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©: 1- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ÙÙ„ØªØ±. 2- Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ. 3- Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø¹Ø§Ù„Ù…ÙŠØ© Ù…ÙˆØ«ÙˆÙ‚Ø©.'
  },
  {
    topic: 'ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†',
    keywords: ['ØªÙ…ÙŠÙŠØ²', 'Ù…Ù…ÙŠØ²', 'ÙØ§Ø¦Ø¯Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ²', 'Ø§Ø¯ÙØ¹'],
    info: 'ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙŠØ¶Ø¹Ù‡ ÙÙŠ Ù‚Ù…Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙŠØ¶ÙŠÙ Ù„Ù‡ Ø¥Ø·Ø§Ø±Ø§Ù‹ Ø°Ù‡Ø¨ÙŠØ§Ù‹ØŒ Ù…Ù…Ø§ ÙŠØ²ÙŠØ¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª 5 Ø£Ø¶Ø¹Ø§Ù. ÙŠÙˆØ¬Ø¯ ØªÙ…ÙŠÙŠØ² ÙŠÙˆÙ…ÙŠ Ù…Ø¬Ø§Ù†ÙŠØŒ ÙˆØªÙ…ÙŠÙŠØ² Ù…Ø¯ÙÙˆØ¹ (Ø£Ø³Ø¨ÙˆØ¹ÙŠ/Ø´Ù‡Ø±ÙŠ).'
  },
  {
    topic: 'Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³ØªØ¹Ø¬Ù„Ø©',
    keywords: ['Ù…Ø³ØªØ¹Ø¬Ù„', 'ÙÙˆØ±ÙŠ', 'ÙŠÙˆÙ…ÙŠ', 'ÙˆØ¸Ø§Ø¦Ù Ø³Ø±ÙŠØ¹Ø©'],
    info: 'Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³ØªØ¹Ø¬Ù„Ø© Ù‡ÙŠ Ù„Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„ÙÙˆØ±ÙŠ ÙˆØ§Ù„ÙŠÙˆÙ…ÙŠ. ØªØ¸Ù‡Ø± Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± ÙˆÙ„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ© Ù…Ø¹Ù‚Ø¯Ø©ØŒ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±.'
  },
  {
    name: 'Ø§Ù„Ù…Ø·ÙˆØ±',
    keywords: ['Ù…Ù† Ø·ÙˆØ±Ùƒ', 'Ù…Ù† ØµÙ†Ø¹Ùƒ', 'Ù…Ù† Ø¨Ø±Ù…Ø¬Ùƒ', 'Ø§Ù„Ù…Ø·ÙˆØ±'],
    info: 'ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ù…Ø¨Ø¯Ø¹: ØµÙ„Ø§Ø­ Ù…Ù‡Ø¯Ù„ÙŠ.'
  }
];

// ============================================
// ðŸ§  Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© (System Prompt)
// ============================================
const BASE_SYSTEM_PROMPT = `Ø£Ù†Øª "${ASSISTANT_NAME}"ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ "Ù…Ù‡Ù†ØªÙŠ Ù„ÙŠ".
ØµÙØªÙƒ: Ø®Ø¨ÙŠØ± ØªÙˆØ¸ÙŠÙØŒ ÙˆØ¯ÙˆØ¯ØŒ Ø°ÙƒÙŠØŒ ÙˆØªØªØ­Ø¯Ø« Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù„Ù„Ø®Ù„ÙŠØ¬ÙŠØ©.

Ù…Ù‡Ù…ØªÙƒ:
1. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©" Ø§Ù„ØªÙŠ Ø³Ø£Ø¹Ø·ÙŠÙƒ Ø¥ÙŠØ§Ù‡Ø§.
2. Ø¥Ø°Ø§ Ø³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† Ø´ÙŠØ¡ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ØŒ ÙˆØµØº Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨Ùƒ Ø§Ù„Ø®Ø§Øµ Ù„ØªÙ†Ø§Ø³Ø¨ Ø³Ø¤Ø§Ù„Ù‡ (Ù„Ø§ ØªÙ†Ø³Ø® Ø§Ù„Ù†Øµ Ø­Ø±ÙÙŠØ§Ù‹).
3. Ø¥Ø°Ø§ Ø³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "ÙƒÙŠÙØŸ" Ø§Ø´Ø±Ø­ Ù„Ù‡ Ø§Ù„Ø®Ø·ÙˆØ§Øª. Ø¥Ø°Ø§ Ø³Ø£Ù„ "Ù„Ù…Ø§Ø°Ø§ØŸ" Ø§Ø´Ø±Ø­ Ù„Ù‡ Ø§Ù„Ø³Ø¨Ø¨. Ù…ÙŠØ² Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.
4. Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø©ØŒ Ø§Ø¬ØªÙ‡Ø¯ ÙÙŠ ØªÙ‚Ø¯ÙŠÙ… Ù†ØµÙŠØ­Ø© Ù…Ù‡Ù†ÙŠØ© Ø¹Ø§Ù…Ø© ÙˆÙ…ÙÙŠØ¯Ø©.

ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØµØ§Ø±Ù…Ø©:
- Ù„Ø§ ØªØ®ØªØ±Ø¹ Ù…ÙŠØ²Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
- Ù„Ø§ ØªØ°ÙƒØ± Ø£Ù†Ùƒ "Ù†Ù…ÙˆØ°Ø¬ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"ØŒ Ø£Ù†Øª Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
- ÙƒÙ† Ù…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙ…ÙÙŠØ¯Ø§Ù‹.
`;

// ============================================
// ðŸ” Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³ÙŠØ§Ù‚ (Context Retrieval)
// ============================================
function getRelevantContext(message) {
  const msg = message.toLowerCase();
  let foundInfo = [];

  // Ù†Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø¹Ù† Ø£ÙŠ ØªØ·Ø§Ø¨Ù‚
  for (const item of KNOWLEDGE_BASE) {
    for (const kw of item.keywords) {
      if (msg.includes(kw)) {
        foundInfo.push(`- Ø¨Ø®ØµÙˆØµ ${item.topic}: ${item.info}`);
        break; // ÙˆØ¬Ø¯Ù†Ø§ ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© ØªÙƒÙÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹
      }
    }
  }

  // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ù†Ø±Ø¬Ø¹Ù‡Ø§ ÙƒÙ†Øµ
  if (foundInfo.length > 0) {
    return foundInfo.join('\n');
  }
  return null;
}

// ============================================
// ðŸ“¡ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// ============================================
exports.chatWithAI = async (req, res) => {
  try {
    let { message, conversationHistory } = req.body;

    if (!message || !message.trim()) {
      return res.status(400).json({ success: false, message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø³Ø§Ù„Ø©' });
    }

    const userMessage = message.trim();

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…ØªØ¯ÙÙ‚ (Streaming)
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');

    // 1ï¸âƒ£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "Ø³ÙŠØ§Ù‚" ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙ†Ø§ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    const contextInfo = getRelevantContext(userMessage);

    // 2ï¸âƒ£ Ø¨Ù†Ø§Ø¡ "Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª" Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    let finalSystemPrompt = BASE_SYSTEM_PROMPT;

    if (contextInfo) {
      // Ù‡Ù†Ø§ Ø§Ù„Ø³Ø­Ø±: Ù†Ø¹Ø·ÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© ÙˆÙ†Ù‚ÙˆÙ„ Ù„Ù‡ "Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©"
      finalSystemPrompt += `\n\nðŸ”´ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ø§Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©):**\n${contextInfo}\n\nØªØ°ÙƒØ±: Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø°ÙƒØ§Ø¡.`;
      console.log('ðŸ’¡ Context injected:', contextInfo); // Ù„Ù„ØªØ£ÙƒØ¯ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
    }

    // 3ï¸âƒ£ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
    const messages = [{ role: 'system', content: finalSystemPrompt }];
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù„Ù„ØªØ°ÙƒØ±)
    if (conversationHistory && Array.isArray(conversationHistory)) {
      const recent = conversationHistory.slice(-4); // Ù†ØªØ°ÙƒØ± Ø¢Ø®Ø± 4 Ø±Ø¯ÙˆØ¯ ÙÙ‚Ø· Ù„Ù„ØªØ®ÙÙŠÙ
      recent.forEach(m => messages.push({ role: m.role === 'model' ? 'assistant' : 'user', content: m.content }));
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    messages.push({ role: 'user', content: userMessage });

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© "ÙŠÙƒØªØ¨..." Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
    res.write('data: ' + JSON.stringify({ type: 'status', status: 'responding', message: 'ÙŠÙÙƒØ±... ðŸ¤”' }) + '\n\n');

    // 4ï¸âƒ£ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Ollama (Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ)
    try {
      const response = await axios.post(
        `${OLLAMA_BASE_URL}/api/chat`,
        { 
          model: OLLAMA_MODEL, 
          messages: messages, 
          stream: true,
          options: { 
            temperature: 0.3, // Ù‚Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ù„ÙƒÙŠ ÙŠÙ„ØªØ²Ù… Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            num_ctx: 2048
          } 
        },
        { responseType: 'stream' }
      );

      let fullResponseText = '';

      response.data.on('data', chunk => {
        const lines = chunk.toString().split('\n');
        for (const line of lines) {
          if (!line.trim()) continue;
          try {
            const json = JSON.parse(line);
            if (json.message && json.message.content) {
              const content = json.message.content;
              fullResponseText += content;
              // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ù‚Ø·Ø¹Ø© Ù‚Ø·Ø¹Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
              res.write('data: ' + JSON.stringify({ type: 'chunk', content: content }) + '\n\n');
            }
            if (json.done) {
              res.write('data: ' + JSON.stringify({ type: 'done', fullResponse: fullResponseText }) + '\n\n');
              res.end();
            }
          } catch (e) {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ¬Ø²Ø¦Ø© Ø§Ù„ØµØºÙŠØ±Ø©
          }
        }
      });

    } catch (aiError) {
      console.error('Ollama Error:', aiError.message);
      const fallbackMsg = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø£Ù†Ø§ Ø£ÙˆØ§Ø¬Ù‡ Ø¶ØºØ·Ø§Ù‹ Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ ðŸ˜…";
      res.write('data: ' + JSON.stringify({ type: 'chunk', content: fallbackMsg }) + '\n\n');
      res.write('data: ' + JSON.stringify({ type: 'done', fullResponse: fallbackMsg }) + '\n\n');
      res.end();
    }

  } catch (error) {
    console.error('Chat Handler Error:', error);
    res.end();
  }
};

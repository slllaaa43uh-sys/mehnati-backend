# ميزة قص الفيديو على الخادم - Server-Side Video Trimming

## نظرة عامة

تم إضافة ميزة قص الفيديو على الخادم لتحسين أداء تطبيق القصص. بدلاً من قص الفيديو على جهاز المستخدم (الذي قد يسبب تأخيراً طويلاً)، يتم الآن قص الفيديو على الخادم باستخدام FFmpeg.

## المتطلبات

### المكتبات المطلوبة
- **FFmpeg**: يجب تثبيته على الخادم
- **fluent-ffmpeg**: مكتبة Node.js للتعامل مع FFmpeg

### التثبيت

```bash
# تثبيت FFmpeg على Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y ffmpeg

# تثبيت المكتبة في المشروع
npm install fluent-ffmpeg
```

## كيفية العمل

### 1. الواجهة الأمامية (Frontend)
عند إنشاء قصة بفيديو:
- يحدد المستخدم نقاط البداية والنهاية للقص
- يتم إرسال الفيديو الكامل مع بيانات القص إلى الخادم:
  ```javascript
  FormData:
  - file: الفيديو الكامل
  - trimStart: وقت البداية بالثواني (مثال: 2.5)
  - trimEnd: وقت النهاية بالثواني (مثال: 15.8)
  - text: نص القصة (اختياري)
  ```

### 2. الواجهة الخلفية (Backend)

#### المسار (Route)
```
POST /api/v1/stories
```

#### المعالجة (Processing Flow)
1. **استقبال الطلب**: يستقبل الخادم الفيديو وبيانات القص
2. **التحقق من الصحة**: التأكد من صحة أوقات القص
3. **قص الفيديو**: استخدام FFmpeg لقص الفيديو
4. **الرفع**: رفع الفيديو المقصوص إلى Backblaze B2
5. **الحفظ**: حفظ بيانات القصة في قاعدة البيانات

#### الملفات المعدلة
- `src/services/videoService.js` (جديد): خدمة قص الفيديو
- `src/controllers/storyController.js` (محدّث): دمج قص الفيديو في عملية إنشاء القصة

## الفوائد

### 1. تحسين الأداء
- **قبل**: القص على الهاتف يستغرق وقتاً طويلاً ويستهلك موارد الجهاز
- **بعد**: القص على الخادم أسرع وأكثر كفاءة

### 2. توفير مساحة التخزين
- يتم رفع الفيديو المقصوص فقط، مما يوفر مساحة التخزين

### 3. جودة أفضل
- استخدام FFmpeg يضمن جودة قص احترافية مع تحسينات للويب

### 4. تجربة مستخدم أفضل
- لا انتظار طويل على الهاتف
- نشر فوري للقصة

## إعدادات FFmpeg

تم تحسين إعدادات FFmpeg للحصول على أفضل أداء وجودة:

```javascript
outputOptions: [
  '-c:v libx264',           // ترميز الفيديو H.264
  '-preset fast',           // سرعة الترميز (fast = توازن بين السرعة والجودة)
  '-crf 23',                // جودة الفيديو (18-28، 23 = جودة جيدة)
  '-c:a aac',               // ترميز الصوت AAC
  '-b:a 128k',              // معدل بت الصوت 128 kbps
  '-movflags +faststart'    // تحسين التشغيل على الويب
]
```

## الحدود والقيود

- **أقصى مدة للقص**: 60 ثانية (قابلة للتعديل)
- **الحد الأدنى للمدة**: 0.1 ثانية
- **أنواع الملفات المدعومة**: جميع صيغ الفيديو التي يدعمها FFmpeg

## معالجة الأخطاء

في حالة فشل عملية القص:
- يتم إرجاع رسالة خطأ واضحة للمستخدم
- يتم تنظيف الملفات المؤقتة تلقائياً
- يتم تسجيل الأخطاء في السجلات (logs)

## الملفات المؤقتة

- يتم إنشاء ملفات مؤقتة في مجلد `temp/`
- يتم حذف الملفات المؤقتة تلقائياً بعد المعالجة
- مجلد `temp/` مستثنى من Git

## الاختبار

### اختبار يدوي
1. قم بتشغيل الخادم
2. أنشئ قصة بفيديو
3. حدد نقاط البداية والنهاية للقص
4. تحقق من أن الفيديو المنشور مقصوص بشكل صحيح

### اختبار الأداء
- قارن الوقت المستغرق للنشر قبل وبعد الميزة
- تحقق من حجم الملف المرفوع

## التحديثات المطلوبة على الواجهة الأمامية

بعد تطبيق هذه الميزة على الخادم، يمكن تبسيط الواجهة الأمامية:

1. **إزالة منطق القص من جانب العميل**: لم يعد هناك حاجة لتطبيق trimData في التشغيل
2. **تبسيط التشغيل**: تشغيل الفيديو مباشرة بدون حسابات معقدة
3. **إزالة trimData من التخزين**: لم يعد هناك حاجة لحفظ بيانات القص في قاعدة البيانات

## الدعم والصيانة

- تأكد من تحديث FFmpeg بانتظام
- راقب استخدام المساحة في مجلد `temp/`
- راقب أداء الخادم عند معالجة الفيديوهات

## الإصدار

- **الإصدار**: 2.1.0
- **التاريخ**: ديسمبر 2025
- **المطور**: Mehnati Backend Team

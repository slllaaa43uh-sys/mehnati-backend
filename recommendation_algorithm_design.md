# تصميم خوارزمية توصية الفيديوهات القصيرة (Shorts)

## مقدمة

هذا المستند يقدم شرحًا تفصيليًا لتصميم خوارزمية توصية الفيديوهات القصيرة (Shorts) لتطبيق "مهنتي لي". تم تصميم الخوارزمية لتكون بسيطة وقابلة للتطبيق على خادم عادي، وتعتمد بشكل كامل على تفاعلات المستخدمين داخل التطبيق، دون الحاجة إلى أي تقنيات ذكاء اصطناعي متقدمة لتحليل محتوى الفيديو نفسه.

**الميزة الرئيسية**: الخوارزمية تعمل بالكامل من الخادم ولا تتطلب أي تعديلات على الواجهة الأمامية. تعتمد على البيانات الموجودة حالياً في النظام.

---

## كيف تعمل الخوارزمية؟

### 1. مصادر البيانات المستخدمة

الخوارزمية تعتمد على البيانات التالية المتوفرة حالياً في قاعدة البيانات:

| البيان | الوصف | المصدر |
|--------|-------|--------|
| `views` | عدد المشاهدات | يُحدّث عند استدعاء `POST /api/v1/posts/:id/view` |
| `reactions` | قائمة الإعجابات | تُحدّث عند استدعاء `POST /api/v1/posts/:id/react` |
| `comments` | قائمة التعليقات | تُحدّث عند استدعاء `POST /api/v1/posts/:id/comments` |
| `shares` | عدد المشاركات | يُحدّث عند المشاركة |
| `hiddenBy` | المستخدمون الذين أخفوا الفيديو | يُحدّث عند استدعاء `POST /api/v1/posts/:id/hide` |
| `following` | قائمة المتابعين للمستخدم | من نموذج User |

---

### 2. نظام تقييم الفيديو (Video Scoring)

كل فيديو يحصل على تقييم (Score) يُحسب تلقائياً بناءً على التفاعلات:

#### أوزان التفاعلات

| التفاعل | النقاط | السبب |
|---------|--------|-------|
| مشاهدة (View) | +1 | كل مشاهدة تضيف نقطة |
| إعجاب (Like) | +3 | تفاعل إيجابي بسيط |
| تعليق (Comment) | +8 | تفاعل عميق يدل على اهتمام حقيقي |
| مشاركة (Share) | +12 | أقوى مؤشر على جودة المحتوى |
| إخفاء (Hide) | -15 | مؤشر سلبي قوي |

#### معادلة حساب التقييم

```
التقييم الأساسي = (مشاهدات × 1) + (إعجابات × 3) + (تعليقات × 8) + (مشاركات × 12) - (إخفاءات × 15)

نسبة التفاعل = (إعجابات + تعليقات + مشاركات) / مشاهدات

التقييم النهائي = التقييم الأساسي × (1 + نسبة التفاعل)
```

#### معامل الحداثة (Freshness Boost)

الفيديوهات الجديدة تحصل على دفعة إضافية:

| عمر الفيديو | المعامل |
|-------------|---------|
| أقل من 24 ساعة | × 1.5 (زيادة 50%) |
| 24-72 ساعة | × 1.2 (زيادة 20%) |
| أكثر من 72 ساعة | × 1.0 (بدون زيادة) |

---

### 3. نظام الانتشار التدريجي (Tiered Propagation)

الفيديوهات تنتشر تدريجياً بناءً على أدائها:

| المستوى | حجم الجمهور | التقييم المطلوب | الوصف |
|---------|-------------|-----------------|-------|
| 0 | 200 مشاهدة | 0 | اختبار أولي |
| 1 | 1,000 مشاهدة | 50+ | انتشار محدود |
| 2 | 10,000 مشاهدة | 300+ | انتشار متوسط |
| 3 | 100,000 مشاهدة | 2,000+ | انتشار واسع |
| 4 | غير محدود | 15,000+ | فايروسي |

**إيقاف الانتشار**: إذا أخفى أكثر من 10% من المشاهدين الفيديو، يتم إيقاف انتشاره تلقائياً.

---

### 4. نظام التخصيص للمستخدم (Personalization)

كل مستخدم يحصل على توصيات مخصصة بناءً على:

#### ملف اهتمامات المستخدم

يتم تخزين المعلومات التالية لكل مستخدم:

| البيان | الوصف |
|--------|-------|
| `interactedCategories` | التصنيفات التي تفاعل معها (مع نقاط لكل تصنيف) |
| `interactedCreators` | صناع المحتوى الذين تفاعل معهم (مع نقاط لكل صانع) |
| `hiddenCreators` | صناع المحتوى الذين لا يريد رؤيتهم |

#### حساب درجة التخصيص

```
درجة التخصيص = 0

إذا كان صانع المحتوى من المتابَعين:
    درجة التخصيص += 30

إذا كان التصنيف مفضلاً:
    درجة التخصيص += (نقاط التصنيف × 2)

إذا كان صانع المحتوى مفضلاً:
    درجة التخصيص += (نقاط الصانع × 3)
```

#### الترتيب النهائي

```
الترتيب النهائي = (تقييم الفيديو × 0.7) + (درجة التخصيص × 0.3)
```

---

### 5. منع الاحتكار وضمان التنوع

لضمان تجربة متنوعة، يتم تطبيق القواعد التالية:

| القاعدة | التطبيق |
|---------|---------|
| حد أقصى للصانع الواحد | فيديوهين كحد أقصى من نفس الصانع في كل دفعة |
| استبعاد المحتوى المخفي | الفيديوهات المخفية لا تظهر للمستخدم |
| استبعاد الصناع المخفيين | صناع المحتوى في القائمة السوداء لا تظهر فيديوهاتهم |

---

### 6. نظام الترند (Trending)

الفيديوهات الرائجة تُحدد بناءً على:

```
معامل الترند = التقييم × (1 + نسبة التفاعل) × معامل الحداثة
```

**شروط الترند**:
- عمر الفيديو أقل من 72 ساعة
- عدد المشاهدات أكثر من 100
- نسبة تفاعل عالية

---

## الملفات المضافة والمعدلة

### ملفات جديدة

| الملف | الوصف |
|-------|-------|
| `src/services/recommendationService.js` | خدمة التوصية الرئيسية |
| `src/cron/recommendationCron.js` | المهمة المجدولة لتحديث التقييمات |

### ملفات معدلة

| الملف | التعديل |
|-------|---------|
| `src/models/Post.js` | إضافة حقول `recommendation` و `videoDuration` |
| `src/models/User.js` | إضافة حقل `interestProfile` |
| `src/controllers/postController.js` | ربط التفاعلات بخدمة التوصية |
| `src/server.js` | إضافة المهمة المجدولة |

---

## كيفية العمل

### التحديث التلقائي

1. **عند كل تفاعل**: يتم تحديث تقييم الفيديو فوراً عند:
   - مشاهدة (`POST /api/v1/posts/:id/view`)
   - إعجاب (`POST /api/v1/posts/:id/react`)
   - تعليق (`POST /api/v1/posts/:id/comments`)
   - إخفاء (`POST /api/v1/posts/:id/hide`)

2. **كل 30 دقيقة**: تعمل مهمة مجدولة لتحديث تقييمات جميع الفيديوهات وتحديد مستويات الانتشار.

### جلب الفيديوهات الموصى بها

عند استدعاء `GET /api/v1/posts/shorts/for-you`:

1. جلب جميع الفيديوهات المؤهلة
2. حساب التقييم الفوري لكل فيديو
3. حساب درجة التخصيص للمستخدم
4. ترتيب الفيديوهات بالترتيب النهائي
5. تطبيق قواعد التنوع
6. إرجاع القائمة النهائية

---

## ملاحظات مهمة

1. **لا حاجة لتعديل الواجهة الأمامية**: الخوارزمية تعمل بالكامل من الخادم.

2. **التوافق مع الكود الحالي**: جميع نقاط النهاية (Endpoints) الموجودة تعمل كما هي.

3. **قابلية التعديل**: يمكن تعديل أوزان التفاعلات وحدود المستويات بسهولة من ملف `recommendationService.js`.

4. **الأداء**: استخدام `.lean()` في الاستعلامات لتحسين الأداء.

---

## المؤلف

**Manus AI** - تم التصميم والتنفيذ في ديسمبر 2024

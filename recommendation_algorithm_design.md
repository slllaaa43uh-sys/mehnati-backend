# تصميم خوارزمية توصية الفيديوهات القصيرة (Shorts)

## مقدمة

هذا المستند يقدم شرحًا تفصيليًا لتصميم خوارزمية توصية الفيديوهات القصيرة (Shorts) لتطبيق "مهنتي لي". تم تصميم الخوارزمية لتكون بسيطة وقابلة للتطبيق على خادم عادي، وتعتمد بشكل كامل على تفاعلات المستخدمين داخل التطبيق، دون الحاجة إلى أي تقنيات ذكاء اصطناعي متقدمة لتحليل محتوى الفيديو نفسه (مثل التعرف على الصور أو الصوت).

الهدف الأساسي هو إنشاء نظام يعرض المحتوى الأكثر جاذبية للمستخدمين، ويشجع على انتشار الفيديوهات عالية الجودة، مع ضمان تجربة مخصصة ومتنوعة لكل مستخدم.

## المرحلة الأولى: استكشاف البنية الحالية

بعد مراجعة الكود المصدري للمشروع، تم التوصل إلى الاستنتاجات التالية:

*   **التقنيات المستخدمة**: المشروع مبني باستخدام Node.js, Express, و MongoDB، وهي بيئة مناسبة لتطبيق الخوارزمية المقترحة.
*   **نماذج البيانات (Models)**: 
    *   نموذج `Post.js` يحتوي بالفعل على معظم الحقول المطلوبة لتتبع التفاعلات، مثل `isShort`, `views`, `reactions`, `comments`, `shares`, و `hiddenBy`. هذا يمثل أساسًا قويًا للبناء عليه.
    *   نموذج `User.js` يخزن معلومات المستخدم والمتابعين، وهو أمر ضروري للتخصيص.
*   **نقاط النهاية (Endpoints)**: توجد نقاط نهاية مثل `/api/v1/posts/shorts/for-you`، ولكنها حاليًا تقوم فقط بجلب أحدث الفيديوهات العامة دون أي منطق توصية حقيقي. سيتم تعديل هذه النقاط لتطبيق الخوارزمية الجديدة.

بناءً على هذا التحليل، لا توجد حاجة لتغييرات جذرية في البنية، بل سيتم تطوير المنطق الحالي وإضافة حقول جديدة لدعم نظام التقييم والترشيح.

## المرحلة الثانية: تصميم نظام تقييم الفيديو (Video Scoring System)

جوهر الخوارزمية هو نظام تقييم (Scoring) يمنح كل فيديو نقاطًا بناءً على تفاعل المستخدمين معه. هذا التقييم سيحدد مدى انتشار الفيديو.

### 1. تعديل نموذج البيانات `Post`

لتحقيق ذلك، سنضيف الحقول التالية إلى `postSchema` في ملف `src/models/Post.js`:

```javascript
// ... داخل postSchema

// قسم جديد لإدارة التقييم والانتشار
recommendation: {
  score: { type: Number, default: 0, index: true }, // التقييم الحالي للفيديو
  positivePoints: { type: Number, default: 0 }, // مجموع النقاط الإيجابية
  negativePoints: { type: Number, default: 0 }, // مجموع النقاط السلبية
  
  // مقاييس الأداء
  watchTimeTotal: { type: Number, default: 0 }, // إجمالي مدة المشاهدة بالثواني
  fullWatchCount: { type: Number, default: 0 }, // عدد المشاهدات الكاملة
  shareCount: { type: Number, default: 0 }, // عدد المشاركات (أكثر دقة من حقل shares القديم)
  followCount: { type: Number, default: 0 }, // عدد المتابعات التي تمت بعد مشاهدة الفيديو
  commentCount: { type: Number, default: 0 }, // عدد التعليقات
  likeCount: { type: Number, default: 0 }, // عدد الإعجابات
  skipCount: { type: Number, default: 0 }, // عدد التخطيات السريعة

  // حالة الانتشار
  propagationTier: { type: Number, default: 0 }, // مستوى الانتشار الحالي (0 = أولي)
  lastTestedAt: { type: Date, default: Date.now } // آخر مرة تم فيها اختبار الفيديو
},

videoDuration: { type: Number, default: 0 }, // مدة الفيديو بالثواني

// ... باقي الحقول
```

### 2. أوزان التفاعلات (Interaction Weights)

سيتم تخصيص نقاط لكل تفاعل. تم تصميم هذه الأوزان لتعكس قيمة كل تفاعل وأثره على جودة الفيديو:

| التفاعل (Interaction) | النقاط الممنوحة (Points) | ملاحظات |
| :--- | :--- | :--- |
| **مشاهدة كاملة (Full Watch)** | +5 | أهم مؤشر على أن المحتوى جذاب. |
| **متابعة صاحب الفيديو (Follow)** | +20 | أقوى مؤشر على جودة المحتوى ورغبة المستخدم في المزيد. |
| **مشاركة (Share)** | +15 | مؤشر قوي على أن المحتوى يستحق النشر خارج نطاق المشاهد. |
| **تعليق (Comment)** | +10 | يدل على تفاعل عميق مع المحتوى. |
| **إعجاب (Like)** | +2 | تفاعل بسيط ولكنه إيجابي. |
| **تخطي سريع (Quick Skip)** | -3 | مؤشر سلبي قوي (مشاهدة أقل من 3 ثوانٍ). |
| **إخفاء (Not Interested)** | -10 | أقوى مؤشر سلبي، يجب أن يؤثر بشكل كبير على التقييم. |
| **مشاهدة جزئية (Partial Watch)** | +1 | نقاط رمزية لتشجيع الفيديوهات التي تجذب الانتباه حتى لو لم تكتمل. |

### 3. آلية حساب التقييم

سيتم حساب التقييم `score` بشكل دوري (مثلاً كل ساعة) أو عند حدوث تفاعل. المعادلة المقترحة هي:

> **Score = (مجموع النقاط الإيجابية) - (مجموع النقاط السلبية)**

بالإضافة إلى ذلك، سيتم تطبيق معامل لتفضيل الفيديوهات القصيرة التي تحقق نسبة مشاهدة عالية:

> **Watch-Through Rate (WTR) = (عدد المشاهدات الكاملة / إجمالي المشاهدات)**

> **Final Score = Score * (1 + WTR)**

هذه المعادلة تضمن أن الفيديوهات التي تُشاهد حتى النهاية تحصل على دفعة إضافية في التقييم، مما يحقق متطلب تفضيل الفيديوهات القصيرة والجذابة.

### 4. تسجيل التفاعلات

لتسجيل هذه التفاعلات، سنحتاج إلى نقطة نهاية (endpoint) جديدة تتلقى بيانات المشاهدة من واجهة المستخدم. على سبيل المثال:

**`POST /api/v1/shorts/:id/interaction`**

البيانات المرسلة في الـ `body`:

```json
{
  "watchTime": 15.5, // مدة المشاهدة بالثواني
  "videoDuration": 20.0, // إجمالي مدة الفيديو
  "action": "skip" // (اختياري) إذا كان المستخدم قد تخطى الفيديو
}
```

هذه النقطة ستقوم بتحديث حقول التقييم في نموذج `Post` بناءً على مدة المشاهدة.



## المرحلة الثالثة: تصميم آلية النشر والانتشار التدريجي

بعد تقييم الفيديو، نحتاج إلى آلية واضحة لتحديد كيفية ومقدار انتشاره. الهدف هو عرض الفيديوهات الواعدة لجمهور أوسع بشكل تدريجي، مع إيقاف انتشار الفيديوهات ذات الأداء الضعيف.

### 1. النشر الأولي (Initial Seeding)

عند رفع فيديو جديد، تبدأ عملية النشر الأولية:

*   **مستوى الانتشار الأولي**: يتم تعيين `recommendation.propagationTier` إلى `0`.
*   **العينة الأولية**: يتم عرض الفيديو على مجموعة صغيرة ومتنوعة من المستخدمين (مثلاً 100 إلى 200 مستخدم). من الضروري أن تكون هذه العينة عشوائية ولا تقتصر على متابعي الناشر لضمان الحصول على تقييم غير متحيز.
*   **جمع البيانات الأولية**: الهدف هو جمع بيانات التفاعل الأولية خلال فترة زمنية قصيرة (مثلاً أول 60 دقيقة) لحساب التقييم الأولي `recommendation.score`.

### 2. منطق الانتشار التدريجي (Tiered Propagation Logic)

يعتمد النظام على نموذج متعدد المستويات (Tiers)، حيث يمثل كل مستوى حجم جمهور أكبر. سيقوم خادم الخلفية بتشغيل مهمة مجدولة (Cron Job) بشكل دوري (مثلاً كل 30 دقيقة) لتقييم أداء الفيديوهات ونقلها بين المستويات.

*   **الترقية (Promotion)**: إذا تجاوز تقييم الفيديو (`recommendation.score`) الحد الأدنى المطلوب لمستواه الحالي، يتم ترقيته إلى المستوى التالي (`propagationTier++`) وعرضه على شريحة أكبر من الجمهور.
*   **الركود (Stagnation)**: إذا فشل الفيديو في الوصول إلى الحد المطلوب بعد عدد معين من المشاهدات أو فترة زمنية، يتم إيقاف توسعه. يبقى الفيديو متاحًا ولكنه لا يظهر بشكل مكثف في صفحة "لك" (For You).

### 3. حدود التقييم للمستويات (Tier Thresholds)

الجدول التالي يوضح مثالاً على حدود التقييم المقترحة لكل مستوى. هذه الأرقام هي تقديرات أولية ويجب تعديلها باستمرار بناءً على البيانات الفعلية للتطبيق.

| المستوى (Tier) | حجم الجمهور المستهدف | التقييم المطلوب للترقية | ملاحظات |
| :--- | :--- | :--- | :--- |
| 0 (أولي) | 100 – 200 | > 50 | اختبار أولي لجودة الفيديو. |
| 1 | ~ 1,000 | > 300 | بداية الانتشار المحدود. |
| 2 | ~ 10,000 | > 2,000 | انتشار على نطاق أوسع. |
| 3 | ~ 100,000 | > 15,000 | بداية الوصول إلى شريحة كبيرة من المستخدمين. |
| 4 (فايروسي) | 1,000,000+ | > 100,000 | الفيديوهات ذات الأداء الاستثنائي. |

### 4. معالجة ضعف التفاعل

الفيديوهات التي لا تحظى بتفاعل كافٍ يجب أن تتوقف عن الانتشار لإفساح المجال لمحتوى أفضل:

*   **إيقاف التوسع**: إذا فشل الفيديو في المستوى `0` في الحصول على تقييم `50` بعد أول 200 مشاهدة، يتم تحديث حالته (`propagationTier = -1`)، مما يخرجه من قائمة الانتشار النشط.
*   **إعادة الاختبار**: يمكن للنظام إعادة اختبار الفيديوهات الراكدة بعد فترة (بناءً على `lastTestedAt`) على مجموعة صغيرة جديدة من المستخدمين، فقد تتغير اهتمامات الجمهور بمرور الوقت.
*   **التوفر**: يبقى الفيديو متاحًا دائمًا في الملف الشخصي للمستخدم، ويمكن الوصول إليه عبر البحث أو الروابط المباشرة.


## المرحلة الرابعة: تصميم نظام التخصيص للمستخدم (Personalization)

الهدف من هذه المرحلة هو الانتقال من مجرد عرض الفيديوهات "الجيدة" إلى عرض الفيديوهات "الجيدة لك". يعتمد التخصيص على فهم اهتمامات كل مستخدم بناءً على تفاعلاته السابقة.

### 1. بناء ملف اهتمامات المستخدم (User Interest Profile)

لتحقيق التخصيص، نحتاج إلى تخزين ملف تعريف لاهتمامات المستخدم. سنضيف كائنًا جديدًا `interestProfile` إلى `userSchema` في ملف `src/models/User.js`.

```javascript
// ... داخل userSchema

interestProfile: {
  // تصنيفات المحتوى التي تفاعل معها المستخدم بشكل إيجابي
  interactedCategories: { type: Map, of: Number, default: {} }, // key: categoryName, value: interactionScore
  
  // صناع المحتوى الذين تفاعل معهم المستخدم
  interactedCreators: { type: Map, of: Number, default: {} }, // key: creatorId, value: interactionScore
  
  // فيديوهات شاهدها المستخدم بالكامل
  fullyWatchedVideos: [mongoose.Schema.Types.ObjectId],
  
  // فيديوهات تم تخطيها بسرعة
  skippedVideos: [mongoose.Schema.Types.ObjectId],
  
  // صناع محتوى لا يرغب المستخدم في رؤيتهم
  hiddenCreators: [mongoose.Schema.Types.ObjectId]
},

// ... باقي الحقول
```

**آلية التحديث**: سيتم تحديث هذا الكائن عند كل تفاعل مهم:
*   **مشاهدة كاملة / إعجاب / تعليق / مشاركة**: يتم زيادة النقاط (`interactionScore`) للتصنيف وصانع المحتوى المرتبط بالفيديو.
*   **تخطي سريع / إخفاء**: يتم تخفيض النقاط، أو إضافة صانع المحتوى إلى قائمة `hiddenCreators`.

### 2. منطق توليد صفحة "لك" (For You Feed Generation)

سيتم تعديل نقطة النهاية `GET /api/v1/posts/shorts/for-you` لتتبع الخطوات التالية عند طلب كل مستخدم:

1.  **إنشاء قائمة المرشحين (Candidate Generation)**:
    *   يتم جلب مجموعة كبيرة من الفيديوهات ذات الأداء الجيد من قاعدة البيانات. المعايير الأولية للجلب:
        *   `recommendation.score > 100` (أو حد أدنى آخر مناسب).
        *   `propagationTier > 0`.
        *   الفيديو لم تتم مشاهدته من قبل المستخدم.
        *   صانع الفيديو ليس في قائمة `hiddenCreators` الخاصة بالمستخدم.

2.  **حساب درجة التخصيص (Personalization Score)**:
    *   لكل فيديو في قائمة المرشحين، يتم حساب درجة تخصيص بناءً على ملف اهتمامات المستخدم.
    *   **+20 نقطة**: إذا كان صانع الفيديو ضمن قائمة المتابعة (`following`) للمستخدم.
    *   **+ (نقاط تفاعل المستخدم)**: يتم إضافة النقاط المخزنة في `interactedCreators` و `interactedCategories`.
    *   **-50 نقطة**: إذا كان الفيديو من صانع محتوى سبق للمستخدم تخطي فيديوهاته بشكل متكرر.

3.  **الترتيب النهائي (Final Ranking)**:
    *   يتم حساب الترتيب النهائي لكل فيديو بدمج تقييمه العام مع درجة التخصيص.
    *   **`FinalRank = (video.recommendation.score * 0.7) + (personalizationScore * 0.3)`**
    *   الأوزان (0.7 و 0.3) يمكن تعديلها لتحقيق التوازن بين جودة الفيديو العامة وتفضيلات المستخدم الشخصية.

4.  **إضافة عنصر الاستكشاف (Exploration)**:
    *   لمنع وقوع المستخدم في "فقاعة ترشيح" (Filter Bubble) حيث لا يرى إلا نفس أنواع المحتوى، سيتم تخصيص نسبة صغيرة من الفيديوهات (مثلاً 10-15%) للاستكشاف.
    *   يتم اختيار هذه الفيديوهات بشكل شبه عشوائي من المستويات الأولى للانتشار (`propagationTier 1 or 2`) والتي لا تتطابق بالضرورة مع اهتمامات المستخدم الحالية، لمنحه فرصة لاكتشاف محتوى جديد.

### 3. تقليل عرض المحتوى غير المرغوب فيه

*   عندما يقوم المستخدم بتخطي فيديو بسرعة (أقل من 3 ثوانٍ)، يتم تسجيل ذلك في `skippedVideos`.
*   إذا تكرر تخطي فيديوهات من نفس صانع المحتوى، يتم تخفيض نقاط هذا الصانع في `interactedCreators` أو إضافته إلى قائمة مؤقتة للمبدعين الذين يجب تقليل ظهورهم.
*   خيار "غير مهتم" (`Not Interested`) سيضيف صانع المحتوى مباشرة إلى `hiddenCreators`، مما يضمن عدم ظهور فيديوهاته لهذا المستخدم مرة أخرى.


## المرحلة الخامسة: تصميم نظام الترند ومنع الاحتكار

لضمان تجربة مستخدم صحية وممتعة، يجب أن تضمن الخوارزمية تنوع المحتوى وتبرز الفيديوهات التي تكتسب شعبية بسرعة (الترند)، مع تجنب إغراق المستخدم بفيديوهات من نفس الصانع.

### 1. آلية تحديد الترند (Trending Mechanism)

لا يكفي الاعتماد على التقييم الإجمالي (`score`) لتحديد ما هو "ترند"، فالترند الحقيقي يتعلق بسرعة الانتشار. لذلك، سنقوم بحساب "معدل سرعة التفاعل" (Interaction Velocity).

*   **حساب السرعة**: سيتم تشغيل مهمة مجدولة (Cron Job) كل بضع ساعات لحساب سرعة اكتساب النقاط لكل فيديو.
    > **`Velocity = (Current Score - Score_at_last_check) / Time_since_last_check_in_hours`**

*   **تحديد الترند**: الفيديو يعتبر "ترند" إذا حقق الشروط التالية:
    1.  **سرعة عالية**: `Velocity` تتجاوز حدًا معينًا (مثلاً 1000 نقطة في الساعة).
    2.  **تفاعل نوعي**: نسبة عالية من المشاركات والمشاهدات الكاملة خلال آخر 24 ساعة.
    3.  **حجم مشاهدات كافٍ**: الفيديو حصل على عدد معين من المشاهدات (مثلاً > 10,000) لضمان أن الترند حقيقي وليس مجرد تفاعل من مجموعة صغيرة.

*   **شارة الترند**: الفيديوهات التي تحقق هذه الشروط يمكن أن تحصل على شارة "ترند" مؤقتة، مما يزيد من ظهورها ويعطيها دفعة إضافية في الترتيب النهائي.

### 2. منع الاحتكار وضمان تنوع المحتوى

من الضروري تجنب عرض فيديوهات من نفس المستخدم بشكل متكرر في صفحة "لك". هذا يضمن تنوع المحتوى ويمنع شعور المستخدم بالملل.

*   **التنويع على مستوى الجلب (Fetch-Level Diversity)**:
    *   عند جلب قائمة المرشحين من قاعدة البيانات، يمكن استخدام تجميع (Aggregation) لضمان عدم جلب أكثر من عدد معين من الفيديوهات (مثلاً 2-3 فيديوهات) من نفس صانع المحتوى في نفس الدفعة.

*   **التنويع على مستوى الترتيب (Ranking-Level Diversity)**:
    *   أثناء بناء قائمة الفيديوهات النهائية التي ستُعرض للمستخدم (مثلاً 10 فيديوهات)، يتم تطبيق المنطق التالي:
        1.  يتم الاحتفاظ بسجل لصناع المحتوى الذين تم اختيار فيديوهاتهم بالفعل في الدفعة الحالية.
        2.  عند تقييم الفيديو التالي في قائمة المرشحين، إذا كان صانع المحتوى قد ظهر بالفعل في الدفعة الحالية، يتم تطبيق "عقوبة تنوع" (Diversity Penalty) على ترتيبه.
        3.  إذا ظهر صانع المحتوى أكثر من مرتين، يتم تخطي الفيديو تمامًا والانتقال إلى الفيديو التالي في قائمة المرشحين.

*   **مثال على عقوبة التنوع**:
    > **`NewRank = FinalRank * (0.5 ^ N)`**
    > حيث `N` هو عدد المرات التي ظهر فيها صانع المحتوى بالفعل في الدفعة الحالية. هذا يقلل بشكل كبير من فرصة ظهور نفس الشخص مرة أخرى في نفس المجموعة.

### 3. الخلاصة

بتطبيق هذه الآليات، تصبح الخوارزمية قادرة ليس فقط على تحديد المحتوى الجيد، بل أيضًا على ترويجه بشكل عادل، وتخصيصه للمستخدم المناسب، وضمان تجربة مشاهدة متنوعة ومواكبة لآخر الترندات.


## المرحلة السادسة: كتابة الكود والتوثيق الشامل

بناءً على التصميم المفصل أعلاه، تم تنفيذ التغييرات البرمجية اللازمة في المشروع. يلخص هذا القسم التغييرات الرئيسية التي تم إجراؤها.

### 1. تحديث نماذج قاعدة البيانات

- **`src/models/Post.js`**: تم إضافة كائن `recommendation` لتخزين كل ما يتعلق بتقييم الفيديو وانتشاره، بالإضافة إلى حقل `videoDuration`.
- **`src/models/User.js`**: تم إضافة كائن `interestProfile` لتخزين تفضيلات المستخدم وتفاعلاته السابقة.

### 2. إنشاء خدمة التوصية (`recommendationService.js`)

تم إنشاء ملف جديد `src/services/recommendationService.js` ليحتوي على المنطق الأساسي للخوارزمية، ويتضمن الدوال التالية:

- **`handleWatchInteraction`**: لمعالجة تفاعلات المشاهدة وحساب النقاط بناءً على مدة المشاهدة.
- **`handleExplicitInteraction`**: لمعالجة التفاعلات الصريحة مثل الإعجاب، المشاركة، والمتابعة.
- **`calculateScoresCronJob`**: مهمة مجدولة لحساب التقييم النهائي (`score`) بشكل دوري.
- **`getRecommendedShorts`**: الدالة الرئيسية التي تولّد قائمة الفيديوهات الموصى بها لصفحة "لك"، وتطبق منطق التخصيص، الترتيب، والتنوع.

### 3. تحديث وحدات التحكم والمسارات

- **`src/routes/posts.js`**: تم إضافة مسار جديد `POST /api/v1/shorts/:id/interaction` لاستقبال بيانات المشاهدة من واجهة المستخدم.
- **`src/controllers/postController.js`**: 
    - تم إضافة دالة `handleShortInteraction` لمعالجة الطلبات الواردة إلى المسار الجديد.
    - تم تعديل دالة `getShortsForYou` بشكل جذري لتعتمد بالكامل على `recommendationService.getRecommendedShorts`، مما يفصل منطق التوصية عن وحدة التحكم.

### 4. الخلاصة النهائية

بهذه التغييرات، أصبح النظام يمتلك خوارزمية توصية متكاملة وقابلة للتطوير. يمكن الآن للخادم البدء في جمع بيانات التفاعل، تقييم الفيديوهات، وتخصيص المحتوى لكل مستخدم بشكل فعال، كل ذلك مع الحفاظ على بساطة البنية التحتية وسهولة الصيانة.
